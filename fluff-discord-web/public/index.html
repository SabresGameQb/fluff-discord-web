<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fluff Dice Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            background-color: #1e1e1e;
            color: #fff;
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        input, button {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px;
            margin: 5px;
            border-radius: 5px;
        }
        button:hover {
            background-color: #555;
            cursor: pointer;
        }
        #game-area {
            display: none;
            margin-top: 20px;
        }
        #player-list {
            list-style-type: none;
            padding: 0;
        }
        #player-list li {
            padding: 5px 0;
        }
        .section {
            margin: 20px 0;
        }
        label {
            display: inline-block;
            width: 70px;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ² Fluff Dice Game ðŸŽ²</h1>

    <form id="room-form">
        <div class="section">
            <label for="room-id">Room:</label>
            <input type="text" id="room-id" placeholder="Enter room ID" required>
            <button type="submit">Join</button>
        </div>
    </form>

    <div id="game-area">
        <div class="section">
            <h2>Players</h2>
            <ul id="player-list"></ul>
        </div>

        <div class="section">
            <h2>Current Bid</h2>
            <p id="current-bid">No current bid</p>
        </div>

        <div class="section">
            <form id="bid-form">
                <label for="quantity">Qty:</label>
                <input type="number" id="quantity" min="1" required>
                <label for="face">Face:</label>
                <input type="number" id="face" min="1" max="6" required>
                <button type="submit">Bid</button>
            </form>
        </div>

        <div class="section">
            <button id="fluff-button">Call Fluff</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        let playerName = localStorage.getItem("fluffName") || "";
        if (!playerName) {
            playerName = prompt("Enter your name:") || "Player";
            localStorage.setItem("fluffName", playerName);
        }
        socket.emit("setName", playerName);

        const roomForm = document.getElementById("room-form");
        const roomInput = document.getElementById("room-id");
        const gameArea = document.getElementById("game-area");
        const currentBidDisplay = document.getElementById("current-bid");
        const playerList = document.getElementById("player-list");
        const bidForm = document.getElementById("bid-form");
        const quantityInput = document.getElementById("quantity");
        const faceInput = document.getElementById("face");
        const fluffButton = document.getElementById("fluff-button");

        let myTurn = false;
        let lastBid = null;

        roomForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const roomId = roomInput.value.trim();
            if (roomId) {
                socket.emit("joinRoom", { roomId, name: playerName });
            }
        });

        bidForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const quantity = parseInt(quantityInput.value);
            const face = parseInt(faceInput.value);
            if (validateBid(quantity, face)) {
                socket.emit("makeBid", { quantity, face });
            } else {
                alert("Invalid bid based on Fluff rules!");
            }
        });

        fluffButton.addEventListener("click", () => {
            if (lastBid) {
                socket.emit("callFluff");
            } else {
                alert("No bid to call Fluff on!");
            }
        });

        socket.on("gameJoined", (players) => {
            roomForm.style.display = "none";
            gameArea.style.display = "block";
            updatePlayers(players);
        });

        socket.on("updatePlayers", (players) => {
            updatePlayers(players);
        });

        socket.on("turn", (player) => {
            myTurn = player.name === playerName;
            if (myTurn) {
                alert("It's your turn!");
            }
        });

        socket.on("bidMade", (bid) => {
            lastBid = bid;
            currentBidDisplay.innerText = `${bid.quantity} Ã— ${bid.face}s (Total: ${bid.quantity * bid.face})`;
        });

        socket.on("fluffResult", (result) => {
            alert(result.message);
            lastBid = null;
            currentBidDisplay.innerText = "No current bid";
        });

        function updatePlayers(players) {
            playerList.innerHTML = "";
            players.forEach(p => {
                const li = document.createElement("li");
                li.innerText = p.name;
                playerList.appendChild(li);
            });
        }

        function validateBid(quantity, face) {
            if (!lastBid) return true; // First bid is always valid
            const newTotal = quantity * face;
            const lastTotal = lastBid.quantity * lastBid.face;

            // Must be higher total, OR equal total with different combo
            if (newTotal > lastTotal) return true;
            if (newTotal === lastTotal && (quantity !== lastBid.quantity || face !== lastBid.face)) return true;
            return false;
        }
    </script>
</body>
</html>
